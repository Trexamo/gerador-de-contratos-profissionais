<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ContratoF√°cil - Contratos Profissionais em 5 Minutos</title>
    <link rel="icon" href="logo.jpg" type="image/jpeg">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Sign-In -->
    <meta name="google-signin-client_id" content="395303260900-usl0idov344ud7qo9ptr82mnmqfidebd.apps.googleusercontent.com">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- EmailJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function(){
            emailjs.init("y2Y2FotVDMytchPMg");
        })();
    </script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
</head>
<body>
    <!-- Status Bar -->
    <div class="status-bar" id="statusBar" style="display: none;">
        <div class="container">
            <div class="status-content">
                <div class="status-info">
                    <i class="fas fa-crown" id="statusIcon"></i>
                    <span id="statusText">Plano Gratuito - Visualiza√ß√µes Ilimitadas</span>
                </div>
                <div class="status-actions">
                    <span id="statusCount">Contratos visualizados: <strong>0</strong></span>
                    <button class="btn-upgrade" onclick="openPaymentModal('profissional')">
                        <i class="fas fa-rocket"></i> Fazer Upgrade
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <img src="logo.jpg" alt="ContratoF√°cil" class="logo-img">
                    <span>ContratoF√°cil</span>
                </div>
                <nav class="nav-menu">
                    <ul>
                        <li><a href="#home">In√≠cio</a></li>
                        <li><a href="#generator">Criar Contrato</a></li>
                        <li><a href="planos.html">Planos</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                        <li><a href="politica-de-privacidade.html">Pol√≠tica de Privacidade</a></li>
                        <li><a href="termos-de-uso.html">Termos de Uso</a></li>
                        <!-- √Årea do usu√°rio (aparece quando logado) -->
                        <li id="userNav" style="display: none;">
                            <a href="user.html" class="user-menu">
                                <i class="fas fa-user"></i>
                                <span id="userNameNav"></span>
                            </a>
                        </li>
                    </ul>
                </nav>
                <div class="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
                
                <!-- Bot√£o de login/usu√°rio -->
                <div id="loginButton" class="mobile-hidden">
                    <button class="btn-login" onclick="showLoginModal()">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </div>
                
                <div id="userButton" class="mobile-hidden" style="display: none;">
                    <a href="user.html" class="btn-login">
                        <i class="fas fa-user"></i> Minha Conta
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Se√ß√£o Hero Melhorada -->
    <section class="hero" id="home">
        <div class="container">
            <div class="hero-content">
                <h1>
                    Contratos Profissionais em 
                    <span class="hero-highlight">5 Minutos</span>
                </h1>
                <p>
                    Crie contratos juridicamente v√°lidos com nosso gerador inteligente. 
                    <strong>Visualize gratuitamente</strong> e pague apenas quando baixar.
                </p>
                <div class="hero-buttons">
                    <button class="btn btn-large" onclick="scrollToGenerator()">
                        <i class="fas fa-bolt"></i> Criar Meu Contrato Seguro
                    </button>
                    <button class="btn btn-large btn-outline" onclick="showLoginModal()">
                        <i class="fas fa-eye"></i> Visualizar Gratuitamente
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Se√ß√£o do V√≠deo Persuasivo - CORRIGIDA -->
    <section class="video-section" id="videoSection">
        <div class="container">
            <div class="video-container">
                <h2>‚ö†Ô∏è ATEN√á√ÉO: N√£o Assine Nenhum Contrato Sem Ver Isso!</h2>
                
                <div class="video-wrapper">
                    <video controls autoplay muted playsinline class="intro-video" poster="video-poster.jpg">
                        <source src="video.mp4" type="video/mp4">
                        Seu navegador n√£o suporta o elemento de v√≠deo.
                    </video>
                </div>
                
                <div class="video-cta">
                    <button class="btn btn-large" onclick="scrollToGenerator()">
                        <i class="fas fa-shield-alt"></i> Criar Meu Contrato Seguro Agora
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Generator Section -->
    <section class="generator" id="generator">
        <div class="container">
            <div class="section-title">
                <h2>Crie Seu Contrato Agora</h2>
                <p>Preencha os dados abaixo e visualize em tempo real seu contrato profissional</p>
            </div>
            
            <!-- Aviso de login necess√°rio -->
            <div id="loginRequired" class="login-required" style="display: none;">
                <div class="login-required-content">
                    <i class="fas fa-lock"></i>
                    <h3>Login Necess√°rio</h3>
                    <p>Fa√ßa login para criar e visualizar contratos</p>
                    <button class="btn-login" onclick="showLoginModal()">
                        <i class="fas fa-sign-in-alt"></i> Fazer Login
                    </button>
                </div>
            </div>
            
            <div class="generator-container" id="generatorForm" style="display: none;">
                <!-- Form Section -->
                <div class="form-section">
                    <h3>Informa√ß√µes do Contrato</h3>
                    
                    <div class="form-group">
                        <label for="contractorName">Nome do Contratante *</label>
                        <input type="text" id="contractorName" placeholder="Seu nome ou empresa" aria-required="true">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contractorDoc">CPF/CNPJ do Contratante *</label>
                            <input type="text" id="contractorDoc" placeholder="CPF ou CNPJ" aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="contractorProfession">Profiss√£o do Contratante</label>
                            <input type="text" id="contractorProfession" placeholder="Sua profiss√£o">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="contractorAddress">Endere√ßo do Contratante</label>
                        <input type="text" id="contractorAddress" placeholder="Endere√ßo completo">
                    </div>
                    
                    <div class="form-group">
                        <label for="contractedName">Nome do Contratado *</label>
                        <input type="text" id="contractedName" placeholder="Nome do prestador" aria-required="true">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contractedDoc">CPF/CNPJ do Contratado *</label>
                            <input type="text" id="contractedDoc" placeholder="CPF ou CNPJ" aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="contractedProfession">Profiss√£o do Contratado</label>
                            <input type="text" id="contractedProfession" placeholder="Profiss√£o do prestador">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="contractedAddress">Endere√ßo do Contratado</label>
                        <input type="text" id="contractedAddress" placeholder="Endere√ßo completo">
                    </div>
                    
                    <div class="form-group">
                        <label for="serviceDescription">Descri√ß√£o do Servi√ßo *</label>
                        <textarea id="serviceDescription" rows="4" placeholder="Descreva detalhadamente o servi√ßo a ser prestado" aria-required="true"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="serviceValue">Valor do Servi√ßo (R$) *</label>
                            <input type="text" id="serviceValue" placeholder="0,00" aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">Forma de Pagamento</label>
                            <select id="paymentMethod">
                                <option value="transferencia">Transfer√™ncia Banc√°ria</option>
                                <option value="boleto">Boleto</option>
                                <option value="pix">PIX</option>
                                <option value="cartao">Cart√£o de Cr√©dito</option>
                                <option value="dinheiro">Dinheiro</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Campos de Estado Civil -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contractorCivilState">Estado Civil do Contratante</label>
                            <select id="contractorCivilState">
                                <option value="">Selecione</option>
                                <option value="solteiro(a)">Solteiro(a)</option>
                                <option value="casado(a)">Casado(a)</option>
                                <option value="divorciado(a)">Divorciado(a)</option>
                                <option value="vi√∫vo(a)">Vi√∫vo(a)</option>
                                <option value="uni√£o est√°vel">Uni√£o Est√°vel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="contractedCivilState">Estado Civil do Contratado</label>
                            <select id="contractedCivilState">
                                <option value="">Selecione</option>
                                <option value="solteiro(a)">Solteiro(a)</option>
                                <option value="casado(a)">Casado(a)</option>
                                <option value="divorciado(a)">Divorciado(a)</option>
                                <option value="vi√∫vo(a)">Vi√∫vo(a)</option>
                                <option value="uni√£o est√°vel">Uni√£o Est√°vel</option>
                            </select>
                        </div>
                    </div>

                    <!-- Sistema de Assinatura - Contratado -->
                    <div class="signature-options">
                        <h4>Assinatura do Contratado</h4>
                        
                        <div class="signature-option" onclick="selectSignatureOption('contracted', 'upload', event)">
                            <i class="fas fa-upload"></i>
                            <strong>Anexar Assinatura</strong>
                            <p>Fa√ßa upload de uma imagem da sua assinatura (JPG, PNG)</p>
                            <input type="file" id="contractedSignatureUpload" accept="image/*" style="display: none;" 
                                   onchange="handleSignatureUpload(event, 'contracted')">
                        </div>
                        
                        <div class="signature-option" onclick="selectSignatureOption('contracted', 'draw', event)">
                            <i class="fas fa-paint-brush"></i>
                            <strong>Desenhar Assinatura</strong>
                            <p>Use o mouse ou touch para desenhar sua assinatura</p>
                            <canvas id="contractedSignatureDraw" width="300" height="100" 
                                    style="border: 1px solid #ccc; display: none; margin-top: 10px;"></canvas>
                        </div>
                        
                        <div class="signature-preview" id="contractedSignaturePreview">
                            <p style="color: #666; text-align: center;">Assinatura do Contratado aparecer√° aqui</p>
                        </div>
                        
                        <div class="signature-actions" id="contractedSignatureConfirmation" style="display: none;">
                            <button type="button" class="btn btn-sm" onclick="clearSignature('contracted')">
                                <i class="fas fa-redo"></i> Refazer
                            </button>
                            <button type="button" class="btn btn-sm btn-success" onclick="confirmSignature('contracted')">
                                <i class="fas fa-check"></i> Confirmar
                            </button>
                        </div>
                    </div>

                    <!-- Sistema de Assinatura - Contratante -->
                    <div class="signature-options">
                        <h4>Assinatura do Contratante</h4>
                        
                        <div class="signature-option" onclick="selectSignatureOption('contractor', 'upload', event)">
                            <i class="fas fa-upload"></i>
                            <strong>Anexar Assinatura</strong>
                            <p>Fa√ßa upload de uma imagem da sua assinatura (JPG, PNG)</p>
                            <input type="file" id="contractorSignatureUpload" accept="image/*" style="display: none;"
                                   onchange="handleSignatureUpload(event, 'contractor')">
                        </div>
                        
                        <div class="signature-option" onclick="selectSignatureOption('contractor', 'draw', event)">
                            <i class="fas fa-paint-brush"></i>
                            <strong>Desenhar Assinatura</strong>
                            <p>Use o mouse ou touch para desenhar sua assinatura</p>
                            <canvas id="contractorSignatureDraw" width="300" height="100" 
                                    style="border: 1px solid #ccc; display: none; margin-top: 10px;"></canvas>
                        </div>
                        
                        <div class="signature-preview" id="contractorSignaturePreview">
                            <p style="color: #666; text-align: center;">Assinatura do Contratante aparecer√° aqui</p>
                        </div>
                        
                        <div class="signature-actions" id="contractorSignatureConfirmation" style="display: none;">
                            <button type="button" class="btn btn-sm" onclick="clearSignature('contractor')">
                                <i class="fas fa-redo"></i> Refazer
                            </button>
                            <button type="button" class="btn btn-sm btn-success" onclick="confirmSignature('contractor')">
                                <i class="fas fa-check"></i> Confirmar
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">Data de In√≠cio *</label>
                            <input type="date" id="startDate" aria-required="true">
                        </div>
                        <div class="form-group">
                            <label for="endDate">Data de T√©rmino</label>
                            <input type="date" id="endDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="contractCity">Cidade de Vig√™ncia *</label>
                        <input type="text" id="contractCity" placeholder="Cidade onde o contrato √© v√°lido" aria-required="true">
                    </div>
                    
                    <div class="actions">
                        <button class="btn" onclick="openSecurePreview()" id="previewBtn">
                            <i class="fas fa-eye"></i> <span id="previewText">Visualizar Gratuitamente</span>
                            <div class="spinner" style="display:none;"></div>
                        </button>
                        <button class="btn btn-success" onclick="generateWordPlus()" id="downloadBtn">
                            <i class="fas fa-download"></i> <span id="downloadText">Baixar Contrato - R$ 6,99</span>
                            <div class="spinner" style="display:none;"></div>
                        </button>
                    </div>
                </div>
                
                <!-- Preview Section -->
                <div class="preview-section">
                    <div class="preview-header">
                        <h3>Pr√©-visualiza√ß√£o do Seu Contrato</h3>
                        <p class="preview-notice">‚úÖ Visualiza√ß√£o gratuita - Fa√ßa upgrade para baixar</p>
                    </div>
                    <div class="contract-preview" id="contractPreview">
                        <!-- CONTRATO PROFISSIONAL SER√Å INSERIDO AQUI VIA JAVASCRIPT -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer com link de administra√ß√£o escondido -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>ContratoF√°cil</h3>
                    <p>Criando contratos profissionais de forma simples e segura desde 2024.</p>
                </div>
                <div class="footer-column">
                    <h3>Links R√°pidos</h3>
                    <ul>
                        <li><a href="#home">In√≠cio</a></li>
                        <li><a href="#generator">Criar Contrato</a></li>
                        <li><a href="planos.html">Planos</a></li>
                        <li><a href="faq.html">FAQ</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Suporte</h3>
                    <ul>
                        <li><a href="#" onclick="showContactModal()">Contato</a></li>
                        <li><a href="politica-de-privacidade.html">Pol√≠tica de Privacidade</a></li>
                        <li><a href="termos-de-uso.html">Termos de Uso</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Contato</h3>
                    <ul>
                        <li><a href="mailto:luhkaimn@gmail.com"><i class="fas fa-envelope"></i> luhkaimn@gmail.com</a></li>
                        <li><i class="fas fa-map-marker-alt"></i> Goi√¢nia, GO</li>
                        <!-- Link de administra√ß√£o escondido -->
                        <li style="opacity: 0.3; font-size: 0.7rem;">
                            <a href="admin.html" style="color: #666; text-decoration: none;">
                                <i class="fas fa-cog"></i> Administra√ß√£o
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 ContratoF√°cil. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Finalizar Compra</h3>
                <button class="close-modal" onclick="closePaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalPlanDescription">Plano selecionado</p>
                <h4 id="modalPrice">Total: R$ 0,00</h4>
                
                <div class="payment-options">
                    <div class="payment-option" onclick="selectPayment(this, 'pix')">
                        <div class="payment-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <span>PIX</span>
                    </div>
                    <div class="payment-option" onclick="selectPayment(this, 'cartao')">
                        <div class="payment-icon">
                            <i class="fab fa-cc-visa"></i>
                        </div>
                        <span>Cart√£o</span>
                    </div>
                </div>

                <!-- Informa√ß√µes para PIX -->
                <div id="pixDetails" class="bank-details" style="display: none;">
                    <h4>Pagamento via PIX</h4>
                    <p>Valor: <strong id="pixValue">R$ 6,99</strong></p>
                    <div class="payment-action">
                        <a href="#" id="pixLink" class="btn btn-success" target="_blank">
                            <i class="fas fa-qrcode"></i> Pagar com PIX Agora
                        </a>
                    </div>
                    <p class="payment-note">
                        Voc√™ ser√° redirecionado para o Mercado Pago
                    </p>
                </div>

                <!-- Informa√ß√µes para Cart√£o -->
                <div id="cardDetails" class="bank-details" style="display: none;">
                    <h4>Pagamento com Cart√£o</h4>
                    <p>Valor: <strong id="cardValue">R$ 6,99</strong></p>
                    <div class="payment-action">
                        <a href="#" id="cardLink" class="btn btn-success" target="_blank">
                            <i class="fas fa-credit-card"></i> Pagar com Cart√£o
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Entrar no ContratoF√°cil</h3>
                <button class="close-modal" onclick="closeLoginModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="login-modal-content">
                    <h4>Entre com Google</h4>
                    <p>√â r√°pido, f√°cil e seguro</p>
                    
                    <div id="g_id_onload_modal"
                         data-client_id="395303260900-usl0idov344ud7qo9ptr82mnmqfidebd.apps.googleusercontent.com"
                         data-context="signin"
                         data-ux_mode="popup"
                         data-callback="handleGoogleSignIn"
                         data-auto_prompt="false">
                    </div>

                    <div class="g_id_signin"
                         data-type="standard"
                         data-shape="rectangular"
                         data-theme="filled_blue"
                         data-text="signin_with"
                         data-size="large"
                         data-logo_alignment="left"
                         data-width="300">
                    </div>
                    
                    <p class="login-terms">
                        Ao entrar, voc√™ concorda com nossos <a href="termos-de-uso.html">Termos de Servi√ßo</a> e <a href="politica-de-privacidade.html">Pol√≠tica de Privacidade</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Contato -->
    <div class="modal" id="contactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Entre em Contato</h3>
                <button class="close-modal" onclick="closeContactModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="contactForm" onsubmit="submitContactForm(event)">
                    <div class="form-group">
                        <label for="contactName">Seu Nome *</label>
                        <input type="text" id="contactName" required>
                    </div>
                    <div class="form-group">
                        <label for="contactEmail">Seu Email *</label>
                        <input type="email" id="contactEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="contactSubject">Assunto *</label>
                        <input type="text" id="contactSubject" required>
                    </div>
                    <div class="form-group">
                        <label for="contactMessage">Mensagem *</label>
                        <textarea id="contactMessage" rows="5" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i> Enviar Mensagem
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="script.js"></script>
    
    <!-- JavaScript Corrigido e Melhorado -->
    <script>
        // Verificar se o navegador suporta os recursos necess√°rios
        function checkBrowserSupport() {
            const features = {
                'localStorage': !!window.localStorage,
                'sessionStorage': !!window.sessionStorage,
                'canvas': !!document.createElement('canvas').getContext,
                'fileAPI': !!(window.File && window.FileReader && window.FileList && window.Blob),
                'es6': (() => {
                    try {
                        eval('class Test {}');
                        eval('const test = () => {}');
                        eval('let test = 1');
                        return true;
                    } catch {
                        return false;
                    }
                })()
            };

            const unsupported = Object.entries(features).filter(([_, supported]) => !supported);
            
            if (unsupported.length > 0) {
                console.warn('Recursos n√£o suportados:', unsupported.map(([name]) => name));
                showNotification('‚ö†Ô∏è Seu navegador pode n√£o suportar todos os recursos. Atualize para melhor experi√™ncia.');
            }
        }

        // Sistema de notifica√ß√µes melhorado
        function showNotification(message, type = 'info', duration = 5000) {
            // Remover notifica√ß√µes anteriores
            const existing = document.querySelectorAll('.custom-notification');
            existing.forEach(el => el.remove());

            const notification = document.createElement('div');
            notification.className = `custom-notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button onclick="this.parentElement.remove()">&times;</button>
            `;

            // Adicionar estilos
            const style = document.createElement('style');
            style.textContent = `
                .custom-notification {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    gap: 15px;
                    animation: slideIn 0.3s ease;
                    max-width: 400px;
                }
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                .notification-content {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                .custom-notification button {
                    background: none;
                    border: none;
                    color: white;
                    font-size: 20px;
                    cursor: pointer;
                    padding: 0;
                    width: 24px;
                    height: 24px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(notification);

            // Remover automaticamente
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    notification.style.transform = 'translateX(100%)';
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, duration);
        }

        // Valida√ß√£o de campos do contrato melhorada
        function validateContractData() {
            const errors = [];
            const fields = [
                { id: 'contractorName', name: 'Nome do Contratante' },
                { id: 'contractorDoc', name: 'CPF/CNPJ do Contratante' },
                { id: 'contractedName', name: 'Nome do Contratado' },
                { id: 'contractedDoc', name: 'CPF/CNPJ do Contratado' },
                { id: 'serviceDescription', name: 'Descri√ß√£o do Servi√ßo' },
                { id: 'serviceValue', name: 'Valor do Servi√ßo' },
                { id: 'startDate', name: 'Data de In√≠cio' },
                { id: 'contractCity', name: 'Cidade de Vig√™ncia' }
            ];

            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (!element || !element.value.trim()) {
                    errors.push(field.name);
                }
            });

            // Valida√ß√£o espec√≠fica para CPF/CNPJ
            const contractorDoc = document.getElementById('contractorDoc').value.trim();
            const contractedDoc = document.getElementById('contractedDoc').value.trim();
            
            if (contractorDoc && !isValidCPFOrCNPJ(contractorDoc)) {
                errors.push('CPF/CNPJ do Contratante inv√°lido');
            }
            
            if (contractedDoc && !isValidCPFOrCNPJ(contractedDoc)) {
                errors.push('CPF/CNPJ do Contratado inv√°lido');
            }

            // Valida√ß√£o de data
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (startDate && endDate && new Date(endDate) < new Date(startDate)) {
                errors.push('Data de t√©rmino n√£o pode ser anterior √† data de in√≠cio');
            }

            return errors;
        }

        // Validador de CPF/CNPJ b√°sico
        function isValidCPFOrCNPJ(doc) {
            const cleanDoc = doc.replace(/\D/g, '');
            
            if (cleanDoc.length === 11) {
                // Valida√ß√£o b√°sica de CPF
                return /^\d{11}$/.test(cleanDoc);
            } else if (cleanDoc.length === 14) {
                // Valida√ß√£o b√°sica de CNPJ
                return /^\d{14}$/.test(cleanDoc);
            }
            
            return false;
        }

        // Coletar dados do formul√°rio com sanitiza√ß√£o
        function collectContractData() {
            const fields = [
                'contractorName', 'contractorDoc', 'contractorProfession', 'contractorAddress',
                'contractedName', 'contractedDoc', 'contractedProfession', 'contractedAddress',
                'serviceDescription', 'serviceValue', 'paymentMethod',
                'contractorCivilState', 'contractedCivilState',
                'startDate', 'endDate', 'contractCity'
            ];

            const data = {};
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    // Sanitiza√ß√£o b√°sica
                    let value = element.value.trim();
                    
                    // Sanitizar HTML
                    if (typeof value === 'string') {
                        const div = document.createElement('div');
                        div.textContent = value;
                        value = div.innerHTML;
                    }
                    
                    data[field] = value || '';
                }
            });

            // Adicionar metadata
            data.timestamp = new Date().toISOString();
            data.userAgent = navigator.userAgent;
            data.contractId = 'contract_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Assinaturas
            const contractorSignature = localStorage.getItem('contractor_signature');
            const contractedSignature = localStorage.getItem('contracted_signature');
            
            if (contractorSignature) {
                data.contractorSignature = contractorSignature;
            }
            
            if (contractedSignature) {
                data.contractedSignature = contractedSignature;
            }

            return data;
        }
<div class="actions">
    <button class="btn" onclick="updatePreview(); openSecurePreview()" id="previewBtn">
        <i class="fas fa-eye"></i> <span id="previewText">Visualizar Gratuitamente</span>
        <div class="spinner" style="display:none;"></div>
    </button>
    <button class="btn btn-success" onclick="updatePreview(); generateWordPlus()" id="downloadBtn">
        <i class="fas fa-download"></i> <span id="downloadText">Baixar Contrato - R$ 6,99</span>
        <div class="spinner" style="display:none;"></div>
    </button>
</div>
        // Visualiza√ß√£o segura melhorada
        function openSecurePreview() {
            if (!canGenerateContract()) {
                return;
            }
            
            const validationErrors = validateContractData();
            if (validationErrors.length > 0) {
                showNotification(`‚ùå Corrija os seguintes campos: ${validationErrors.join(', ')}`, 'error');
                return;
            }
            
            // Mostrar loading
            const previewBtn = document.getElementById('previewBtn');
            const originalText = document.querySelector('#previewBtn .spinner');
            const spinner = previewBtn.querySelector('.spinner') || document.createElement('div');
            spinner.className = 'spinner';
            spinner.style.cssText = `
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 2px solid #f3f3f3;
                border-top: 2px solid #3498db;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-left: 10px;
            `;
            
            if (!previewBtn.querySelector('.spinner')) {
                previewBtn.appendChild(spinner);
            }
            
            const textSpan = previewBtn.querySelector('#previewText');
            const originalTextContent = textSpan.textContent;
            textSpan.textContent = 'Processando...';
            previewBtn.disabled = true;

            try {
                const contractData = collectContractData();
                const contractId = 'contract_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                sessionStorage.setItem('secureContractData', JSON.stringify(contractData));
                sessionStorage.setItem('secureContractId', contractId);
                
                // Abrir em nova aba com timeout
                setTimeout(() => {
                    const secureWindow = window.open('view-contract.html', '_blank');
                    
                    if (secureWindow) {
                        showNotification('üëÅÔ∏è Visualiza√ß√£o segura aberta em nova aba', 'success');
                    } else {
                        showNotification('‚ùå Permita pop-ups para visualiza√ß√£o segura', 'error');
                    }
                    
                    // Restaurar bot√£o
                    textSpan.textContent = originalTextContent;
                    previewBtn.disabled = false;
                    spinner.remove();
                }, 1000);
                
            } catch (error) {
                console.error('Erro ao abrir visualiza√ß√£o segura:', error);
                showNotification('‚ùå Erro ao abrir visualiza√ß√£o segura', 'error');
                
                // Restaurar bot√£o em caso de erro
                textSpan.textContent = originalTextContent;
                previewBtn.disabled = false;
                spinner.remove();
            }
        }

        // Sistema de assinaturas melhorado
        const signatureCanvases = {};
        const signatureContexts = {};
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function selectSignatureOption(party, type, event) {
            event.preventDefault();
            
            // Esconder todos os canvases
            document.querySelectorAll(`[id$="SignatureDraw"]`).forEach(canvas => {
                canvas.style.display = 'none';
            });
            
            // Resetar estados de confirma√ß√£o
            document.querySelectorAll('.signature-confirmation').forEach(el => {
                el.style.display = 'none';
            });

            if (type === 'draw') {
                const canvasId = `${party}SignatureDraw`;
                const canvas = document.getElementById(canvasId);
                canvas.style.display = 'block';
                
                // Inicializar canvas
                if (!signatureCanvases[canvasId]) {
                    const ctx = canvas.getContext('2d');
                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.strokeStyle = '#000';
                    
                    signatureCanvases[canvasId] = canvas;
                    signatureContexts[canvasId] = ctx;
                    
                    // Adicionar event listeners
                    canvas.addEventListener('mousedown', startDrawing);
                    canvas.addEventListener('mousemove', draw);
                    canvas.addEventListener('mouseup', stopDrawing);
                    canvas.addEventListener('mouseout', stopDrawing);
                    
                    // Touch events para mobile
                    canvas.addEventListener('touchstart', handleTouchStart);
                    canvas.addEventListener('touchmove', handleTouchMove);
                    canvas.addEventListener('touchend', stopDrawing);
                }
            } else if (type === 'upload') {
                const uploadId = `${party}SignatureUpload`;
                document.getElementById(uploadId).click();
            }
        }

        function startDrawing(e) {
            isDrawing = true;
            const canvas = e.target;
            const rect = canvas.getBoundingClientRect();
            
            if (e.type.includes('touch')) {
                lastX = e.touches[0].clientX - rect.left;
                lastY = e.touches[0].clientY - rect.top;
            } else {
                lastX = e.offsetX;
                lastY = e.offsetY;
            }
        }

        function draw(e) {
            if (!isDrawing) return;
            
            e.preventDefault();
            const canvas = e.target;
            const canvasId = canvas.id;
            const ctx = signatureContexts[canvasId];
            const rect = canvas.getBoundingClientRect();
            
            let currentX, currentY;
            
            if (e.type.includes('touch')) {
                currentX = e.touches[0].clientX - rect.left;
                currentY = e.touches[0].clientY - rect.top;
            } else {
                currentX = e.offsetX;
                currentY = e.offsetY;
            }
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            
            lastX = currentX;
            lastY = currentY;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouchStart(e) {
            if (e.touches.length === 1) {
                startDrawing(e);
            }
        }

        function handleTouchMove(e) {
            if (e.touches.length === 1) {
                draw(e);
            }
        }

        function handleSignatureUpload(event, party) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tipo de arquivo
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                showNotification('‚ùå Por favor, envie apenas imagens (JPG, PNG, GIF)', 'error');
                return;
            }

            // Validar tamanho (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showNotification('‚ùå A imagem deve ter no m√°ximo 2MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const previewId = `${party}SignaturePreview`;
                const previewDiv = document.getElementById(previewId);
                
                previewDiv.innerHTML = `
                    <img src="${e.target.result}" alt="Assinatura ${party}" style="max-width: 200px; max-height: 100px;">
                    <p style="color: green; font-size: 12px; margin-top: 5px;">‚úì Assinatura carregada</p>
                `;

                // Mostrar bot√µes de confirma√ß√£o
                const confirmationId = `${party}SignatureConfirmation`;
                document.getElementById(confirmationId).style.display = 'block';

                // Salvar no localStorage temporariamente
                localStorage.setItem(`${party}_signature_temp`, e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function confirmSignature(party) {
            const tempSignature = localStorage.getItem(`${party}_signature_temp`);
            if (tempSignature) {
                localStorage.setItem(`${party}_signature`, tempSignature);
                localStorage.removeItem(`${party}_signature_temp`);
                showNotification(`‚úì Assinatura do ${party} confirmada!`, 'success');
            } else {
                showNotification('‚ùå Nenhuma assinatura para confirmar', 'error');
            }
        }

        function clearSignature(party) {
            // Limpar canvas
            const canvas = document.getElementById(`${party}SignatureDraw`);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
            
            // Limpar preview
            const preview = document.getElementById(`${party}SignaturePreview`);
            preview.innerHTML = '<p style="color: #666; text-align: center;">Assinatura aparecer√° aqui</p>';
            
            // Esconder confirma√ß√£o
            document.getElementById(`${party}SignatureConfirmation`).style.display = 'none';
            
            // Limpar localStorage
            localStorage.removeItem(`${party}_signature`);
            localStorage.removeItem(`${party}_signature_temp`);
            
            // Resetar upload
            const upload = document.getElementById(`${party}SignatureUpload`);
            if (upload) upload.value = '';
            
            showNotification('Assinatura removida', 'info');
        }

        // Barra de status melhorada
        function updateStatusBar(user) {
            const statusBar = document.getElementById('statusBar');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const statusCount = document.getElementById('statusCount');
            
            if (user) {
                statusBar.style.display = 'block';
                
                if (user.plan === 'free') {
                    statusIcon.className = 'fas fa-eye';
                    statusText.textContent = 'Plano Gratuito - Visualiza√ß√µes Ilimitadas';
                    statusCount.innerHTML = `Contratos visualizados: <strong>${user.contractsGenerated || 0}</strong>`;
                } else if (user.plan === 'basico') {
                    statusIcon.className = 'fas fa-crown';
                    statusText.textContent = 'Plano B√°sico - 5 contratos/m√™s';
                    const remaining = 5 - (user.contractsDownloaded || 0);
                    statusCount.innerHTML = `Contratos restantes: <strong>${Math.max(0, remaining)}</strong>`;
                } else {
                    statusIcon.className = 'fas fa-gem';
                    statusText.textContent = 'Plano Profissional - Ilimitado';
                    statusCount.innerHTML = `Contratos baixados: <strong>${user.contractsDownloaded || 0}</strong>`;
                }
            } else {
                statusBar.style.display = 'none';
            }
        }

        // Modal de contato melhorado
        function showContactModal() {
            const modal = document.getElementById('contactModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Focar no primeiro campo
            setTimeout(() => {
                document.getElementById('contactName').focus();
            }, 100);
        }

        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            document.getElementById('contactForm').reset();
        }

        function submitContactForm(event) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            submitBtn.disabled = true;

            const templateParams = {
                from_name: document.getElementById('contactName').value,
                from_email: document.getElementById('contactEmail').value,
                subject: document.getElementById('contactSubject').value,
                message: document.getElementById('contactMessage').value,
                timestamp: new Date().toISOString()
            };

            emailjs.send('service_s6hcwoa', 'template_wx7bj1m', templateParams)
                .then(function(response) {
                    showNotification('‚úÖ Mensagem enviada com sucesso! Entraremos em contato em breve.', 'success');
                    closeContactModal();
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, function(error) {
                    showNotification('‚ùå Erro ao enviar mensagem. Tente novamente ou entre em contato via email.', 'error');
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                });
        }

        // Scroll suave
        function scrollToGenerator() {
            document.getElementById('generator').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar suporte do navegador
            checkBrowserSupport();
            
            // Inicializar usu√°rio
            const user = JSON.parse(localStorage.getItem('currentUser'));
            updateStatusBar(user);
            
            // Atualizar formul√°rio baseado no login
            if (user) {
                document.getElementById('generatorForm').style.display = 'flex';
                document.getElementById('loginRequired').style.display = 'none';
            } else {
                document.getElementById('generatorForm').style.display = 'none';
                document.getElementById('loginRequired').style.display = 'block';
            }
            
            // Adicionar m√°scara para CPF/CNPJ
            const docFields = ['contractorDoc', 'contractedDoc'];
            docFields.forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, '');
                        
                        if (value.length <= 11) {
                            // CPF: 000.000.000-00
                            value = value.replace(/(\d{3})(\d)/, '$1.$2');
                            value = value.replace(/(\d{3})(\d)/, '$1.$2');
                            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                        } else {
                            // CNPJ: 00.000.000/0000-00
                            value = value.replace(/(\d{2})(\d)/, '$1.$2');
                            value = value.replace(/(\d{3})(\d)/, '$1.$2');
                            value = value.replace(/(\d{3})(\d)/, '$1/$2');
                            value = value.replace(/(\d{4})(\d{1,2})$/, '$1-$2');
                        }
                        
                        e.target.value = value;
                    });
                }
            });
            
            // Adicionar m√°scara para valor
            const valueField = document.getElementById('serviceValue');
            if (valueField) {
                valueField.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    value = (parseInt(value) / 100).toFixed(2);
                    value = parseFloat(value).toLocaleString('pt-BR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    e.target.value = value;
                });
            }
            
            // Adicionar valida√ß√£o em tempo real
            const requiredFields = document.querySelectorAll('[aria-required="true"]');
            requiredFields.forEach(field => {
                field.addEventListener('blur', function() {
                    if (!this.value.trim()) {
                        this.style.borderColor = '#dc3545';
                    } else {
                        this.style.borderColor = '#ddd';
                    }
                });
                
                field.addEventListener('input', function() {
                    if (this.value.trim()) {
                        this.style.borderColor = '#28a745';
                    }
                });
            });
            
            // Fechar modais com ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeLoginModal();
                    closePaymentModal();
                    closeContactModal();
                }
            });
            
            // Fechar modais clicando fora
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                        document.body.style.overflow = 'auto';
                    }
                });
            });
            
            // Mobile menu toggle
            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            const navMenu = document.querySelector('.nav-menu');
            
            if (mobileMenuToggle) {
                mobileMenuToggle.addEventListener('click', function() {
                    navMenu.classList.toggle('active');
                });
            }
            
            // Fechar menu ao clicar em link
            document.querySelectorAll('.nav-menu a').forEach(link => {
                link.addEventListener('click', () => {
                    navMenu.classList.remove('active');
                });
            });
        });

        // Adicionar anima√ß√£o CSS para spinner
        const spinnerStyle = document.createElement('style');
        spinnerStyle.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(spinnerStyle);
    </script>
</body>
</html>
